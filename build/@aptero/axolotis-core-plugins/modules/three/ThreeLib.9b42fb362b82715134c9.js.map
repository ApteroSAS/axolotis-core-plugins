{"version":3,"file":"@aptero/axolotis-core-plugins/modules/three/ThreeLib.9b42fb362b82715134c9.js","mappings":";;;;;;;;;;;wYAYO,MAAMA,EAA6B,IAZnC,MAAmB,mCACV,IADU,gBAEf,IAEM,gBAACC,EAAoBC,GAIlC,OAHKC,KAAKC,YAAYH,KACpBE,KAAKC,YAAYH,SAAoBC,KAEhCC,KAAKC,YAAYH,K,wHCKrBI,eAAeC,IAKpB,aAJyB,6BAOpBD,eAAeE,IAAoB,MACxC,GAAI,UAACC,OAAOC,gBAAR,QAAC,EAAiBC,SAAU,CAC9B,MAAMC,QAAcL,IACpB,IAAII,EAAW,IAAIC,EAAMC,cAAc,CAAEC,WAAW,IACpDH,EAASI,QAAQN,OAAOO,WAAYP,OAAOQ,aAE3CN,EAASO,YAAcN,EAAMO,sBAC7BR,EAASS,oBAAsB,EAC/BT,EAASU,eAAiBT,EAAMU,aAChCX,EAASY,cAAcd,OAAOe,kBAE9BC,SAASC,KAAKC,YAAYhB,EAASiB,YAC9BnB,OAAOC,WACVD,OAAOC,SAAW,IAEpBD,OAAOC,SAASC,SAAWA,EAE7B,OAAOF,OAAOC,SAASC,SAGlB,MAAMkB,EAMXC,YACUC,EACAC,EACApB,GACR,KAHQmB,UAAAA,EAGR,KAFQC,aAAAA,EAER,KADQpB,MAAAA,EACR,gGAN8B,IAQtB,aACRR,KAAK6B,MAAQ,IAAI7B,KAAKQ,MAAMsB,MAE5B9B,KAAKO,eAAiBH,IAEtBJ,KAAK+B,OAAS,IAAI/B,KAAKQ,MAAMwB,kBAC3B,GACA3B,OAAOO,WAAaP,OAAOQ,YAC3B,KACA,KAEFb,KAAK+B,OAAOE,SAASC,EAAI,EAEzB,MAAMC,EAAS,KACb,IAAK,MAAMC,KAAapC,KAAKqC,cAC3BD,IAGFpC,KAAKO,SAAS4B,OAAOnC,KAAK6B,MAAO7B,KAAK+B,QAEtC/B,KAAKO,SAAS+B,WAAY,GAGtBC,EAAiB,KACrBvC,KAAK+B,OAAOS,OAASnC,OAAOO,WAAaP,OAAOQ,YAChDb,KAAK+B,OAAOU,yBACZzC,KAAKO,SAASI,QAAQN,OAAOO,WAAYP,OAAOQ,aAChDsB,KAGFnC,KAAK4B,aAAac,0BAAyB,KACzCrC,OAAOsC,oBAAoB,SAAUJ,GACrCvC,KAAK2B,UAAUiB,WAAWnB,EAASoB,MAC/B7C,KAAK4B,aAAakB,kBACpBzC,OAAO0C,iBAAiB,SAAUR,GAAgB,GAClDvC,KAAK2B,UAAUqB,QAAQvB,EAASoB,KAAMV,OAEvC,GAGW,iBAACc,GACf,GAAIpD,EAAaqD,OAAOD,GACtB,OAAOpD,EAAaqD,OAAOD,GAW7B,GAAIA,EAAKE,SAAS,QAAS,CACzB,MAAMC,QAAevD,EAAawD,UAAU,cAAcnD,SAKrC,WAJO,sDAIIoD,cAI1BC,QAAeH,EAAOI,UAAUP,GACtCpD,EAAaqD,OAAOD,GAAQM,EAE9B,GAAIN,EAAKE,SAAS,QAAS,CACzB,MAAMC,QAAevD,EAAawD,UAAU,iBAAiBnD,SACzC,IAAIF,KAAKQ,MAAMiD,gBAG7BF,QAAeH,EAAOI,UAAUP,GACtCpD,EAAaqD,OAAOD,GAAQM,EAE9B,OAAO1D,EAAaqD,OAAOD,GAG7BS,UACE,OAAOjC,EAASoB,MAIb,MAAMc,EACXjC,eAEmB,oBAACkC,GAClB,IAAIjC,QAAkBiC,EAASC,WAC7B,6CAEEjC,QAAqBgC,EAASC,WAChC,qDAEF,OAAO,IAAIpC,EAASE,EAAWC,QAAoBzB","sources":["webpack://axolotis-core-plugins/./src/lib/modules/three/ThreeAssetsLoader.ts","webpack://axolotis-core-plugins/./src/lib/modules/three/ThreeLib.ts"],"sourcesContent":["export class AssetsLoader {\n  loaderCache = {};\n  assets = {};\n\n  async getLoader(loaderName: string, loaderLoader: () => void) {\n    if (!this.loaderCache[loaderName]) {\n      this.loaderCache[loaderName] = await loaderLoader();\n    }\n    return this.loaderCache[loaderName];\n  }\n}\n\nexport const assetsLoader: AssetsLoader = new AssetsLoader();\n","import { assetsLoader } from \"@root/lib/modules/three/ThreeAssetsLoader\";\nimport Component from \"@aptero/axolotis-player/build/types/modules/core/ecs/Component\";\nimport { WebpackLazyModule } from \"@aptero/axolotis-player/build/types/modules/core/loader/WebpackLoader\";\nimport {\n  FrameLoop,\n  LazyServices,\n  WorldService,\n} from \"@aptero/axolotis-player/build/types\";\nimport { Service } from \"@aptero/axolotis-player/build/types/modules/core/service/LazyServices\";\nimport {PerspectiveCamera, Scene, WebGLRenderer} from \"three\";\n\ndeclare let window: any;\n\nexport async function aTHREE() {\n  const THREE: any = await import(\n    /*  webpackPrefetch: 0,  webpackMode: 'lazy',  webpackChunkName: \"@aptero/axolotis-core-plugins/three\"  */\n    \"three\"\n  );\n  return THREE;\n}\n\nexport async function getGlobalRenderer() {\n  if (!window.axolotis?.renderer) {\n    const THREE = await aTHREE();\n    let renderer = new THREE.WebGLRenderer({ antialias: true });\n    renderer.setSize(window.innerWidth, window.innerHeight);\n\n    renderer.toneMapping = THREE.ACESFilmicToneMapping;\n    renderer.toneMappingExposure = 1;\n    renderer.outputEncoding = THREE.sRGBEncoding;\n    renderer.setPixelRatio(window.devicePixelRatio);\n\n    document.body.appendChild(renderer.domElement);\n    if (!window.axolotis) {\n      window.axolotis = {};\n    }\n    window.axolotis.renderer = renderer;\n  }\n  return window.axolotis.renderer;\n}\n\nexport class ThreeLib implements Component {\n  renderer: WebGLRenderer;\n  scene: Scene;\n  camera: PerspectiveCamera;\n  preRenderPass: (() => void)[] = [];\n\n  constructor(\n    private frameLoop: FrameLoop,\n    private worldService: WorldService,\n    private THREE\n  ) {}\n\n  async init() {\n    this.scene = new this.THREE.Scene();\n\n    this.renderer = await getGlobalRenderer();\n\n    this.camera = new this.THREE.PerspectiveCamera(\n      75,\n      window.innerWidth / window.innerHeight,\n      0.001,\n      100000\n    );\n    this.camera.position.z = 2;\n\n    const render = () => {\n      for (const prerender of this.preRenderPass) {\n        prerender();\n      }\n      // FINAL PASS\n      this.renderer.render(this.scene, this.camera);\n      // set things back to normal\n      this.renderer.autoClear = true;\n    };\n\n    const onWindowResize = () => {\n      this.camera.aspect = window.innerWidth / window.innerHeight;\n      this.camera.updateProjectionMatrix();\n      this.renderer.setSize(window.innerWidth, window.innerHeight);\n      render();\n    };\n\n    this.worldService.addOnWorldChangeCallback(() => {\n      window.removeEventListener(\"resize\", onWindowResize);\n      this.frameLoop.removeLoop(ThreeLib.name);\n      if (this.worldService.isActiveWorld()) {\n        window.addEventListener(\"resize\", onWindowResize, false);\n        this.frameLoop.addLoop(ThreeLib.name, render);\n      }\n    }, true);\n  }\n\n  async loadAssets(path: string) {\n    if (assetsLoader.assets[path]) {\n      return assetsLoader.assets[path];\n    }\n    /*\n    TODO createa a early start download of assets so that the GLB start downloading early in the waterfall\n    Not as simple as it seems may be doable using service worker\n    fetch(path);//start download of assets\n    var oReq = new XMLHttpRequest();\n    oReq.addEventListener(\"load\", ()=>{});\n    oReq.open(\"GET\", path);\n    oReq.send();\n    */\n    if (path.endsWith(\".glb\")) {\n      const loader = await assetsLoader.getLoader(\"GLTFLoader\", async () => {\n        const module: any = await import(\n          /*  webpackPrefetch: 0,  webpackMode: 'lazy',  webpackChunkName: \"@aptero/axolotis-core-plugins/three/examples/jsm/loaders/GLTFLoader\"  */\n          \"three/examples/jsm/loaders/GLTFLoader\"\n        );\n        const gltfLoader = new module.GLTFLoader();\n        //const gltfLoader = new GLTFLoader(new this.THREE.LoadingManager());\n        return gltfLoader;\n      });\n      const result = await loader.loadAsync(path);\n      assetsLoader.assets[path] = result;\n    }\n    if (path.endsWith(\".jpg\")) {\n      const loader = await assetsLoader.getLoader(\"TextureLoader\", async () => {\n        const texLoader = new this.THREE.TextureLoader();\n        return texLoader;\n      });\n      const result = await loader.loadAsync(path);\n      assetsLoader.assets[path] = result;\n    }\n    return assetsLoader.assets[path];\n  }\n\n  getType(): string {\n    return ThreeLib.name;\n  }\n}\n\nexport class Factory implements WebpackLazyModule, Service<ThreeLib> {\n  constructor() {}\n\n  async createService(services: LazyServices): Promise<ThreeLib> {\n    let frameLoop = await services.getService<FrameLoop>(\n      \"@aptero/axolotis-player/modules/FrameLoop\"\n    );\n    let worldService = await services.getService<WorldService>(\n      \"@aptero/axolotis-player/modules/core/WorldService\"\n    );\n    return new ThreeLib(frameLoop, worldService, await aTHREE());\n  }\n}\n"],"names":["assetsLoader","loaderName","loaderLoader","this","loaderCache","async","aTHREE","getGlobalRenderer","window","axolotis","renderer","THREE","WebGLRenderer","antialias","setSize","innerWidth","innerHeight","toneMapping","ACESFilmicToneMapping","toneMappingExposure","outputEncoding","sRGBEncoding","setPixelRatio","devicePixelRatio","document","body","appendChild","domElement","ThreeLib","constructor","frameLoop","worldService","scene","Scene","camera","PerspectiveCamera","position","z","render","prerender","preRenderPass","autoClear","onWindowResize","aspect","updateProjectionMatrix","addOnWorldChangeCallback","removeEventListener","removeLoop","name","isActiveWorld","addEventListener","addLoop","path","assets","endsWith","loader","getLoader","GLTFLoader","result","loadAsync","TextureLoader","getType","Factory","services","getService"],"sourceRoot":""}