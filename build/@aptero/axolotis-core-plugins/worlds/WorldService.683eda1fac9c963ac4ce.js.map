{"version":3,"file":"@aptero/axolotis-core-plugins/worlds/WorldService.683eda1fac9c963ac4ce.js","mappings":";;;;;;;;;;;oQAcO,MAAMA,EACXC,eAEmB,oBAACC,GAClB,OAAO,IAAIC,EAAaD,IAI5B,IAAIE,EAA2C,GAC3CC,EAA0C,GAavC,SAASC,EAAiBC,GAC/B,MAAMC,GAASC,EAAAA,EAAAA,kBAAyB,UACxCD,EAAOA,OAAOE,IAAIH,GACdC,EAAOG,YAAc,IACvBH,EAAOG,YAAc,EACrBH,EAAOI,MAAQJ,EAAOA,OAAOA,EAAOG,eAXnCF,EAAAA,EAAAA,kBAAyB,UAAUE,eAEtCF,EAAAA,EAAAA,kBAAyB,UAAUD,OAAS,IAAIK,KAChDJ,EAAAA,EAAAA,kBAAyB,UAAUE,aAAe,GAY7C,MAAMR,EAGXF,YAAYC,G,iBAAwB,G,EAAA,W,EAAA,M,sFAClCI,EAAiBJ,EAASY,YAC1BC,QAAQC,IAAI,QACZ,IAAIC,EAAgB,KACpB,IAAK,MAAML,KAASM,KAAKC,YAAa,CACpBP,EAAMQ,wBAAkCC,EAAAA,SAAAA,OACvCnB,IACfe,EAAWL,GAGf,IAAKK,EACH,MAAM,IAAIK,MAEZJ,KAAKN,MAAQK,EAGbf,EACGqB,WAAmCC,EAAAA,yBACnCC,MAAKC,MAAAA,IACJC,EAAWC,sBACX,IAAK,MAAMC,KAAYxB,EACrBwB,QAIFpB,EAAAA,EAAAA,kBAAyB,UAAUE,aAAe,GACpDO,KAAKY,wBACHrB,EAAAA,EAAAA,kBAAyB,UAAUE,aAKzCoB,UACE,OAAO5B,EAAa6B,KAGtBb,YAEE,OADoBV,EAAAA,EAAAA,kBAAyB,UACxBD,OAGvByB,iBACE,IAAIC,GAAgBzB,EAAAA,EAAAA,kBAAyB,UAC7C,OAAOS,KAAKC,YAAYe,EAAcvB,aAGxCwB,gBACE,OAAOjB,KAAKN,OAASM,KAAKe,iBAG5B7B,yBAAyByB,GAA6C,IAAvBO,EAAuB,wDACpEhC,EAAyBiC,KAAKR,GAC1BO,GACFP,IAIJS,gBAAgBT,GAA6C,IAAvBO,EAAuB,wDAC3D/B,EAAwBgC,KAAKR,GACzBO,GACFP,IAIJU,eAAe3B,GACb,IAAK,IAAI4B,EAAI,EAAGA,EAAItB,KAAKC,YAAYsB,OAAQD,IAC3C,GAAI5B,GAASM,KAAKC,YAAYqB,GAE5B,YADAtB,KAAKY,uBAAuBU,GAIhC,MAAM,IAAIlB,MAGZQ,uBAAuBY,GACrB,IAAIjC,EAAAA,EAAAA,kBAAyB,UAAUE,aAAe+B,EAAQ,EAC5DjC,EAAAA,EAAAA,kBAAyB,UAAUE,YAAc+B,GACjDjC,EAAAA,EAAAA,kBAAyB,UAAUG,MAAQM,KAAKC,YAAYuB,GAC5D,IAAK,MAAMb,KAAYzB,EACrByB","sources":["webpack://axolotis-core-plugins/./src/lib/modules/worlds/WorldService.ts"],"sourcesContent":["import { WebpackLazyModule } from \"@root/lib/generated/webpack/WebpackLoader\";\nimport { Service } from \"@aptero/axolotis-player/build/types/modules/core/ecs/Service\";\nimport {\n  InitialComponentLoader,\n  LazyServices,\n  Services,\n  WorldEntity,\n} from \"@aptero/axolotis-player\";\nimport Component from \"@aptero/axolotis-player/build/types/modules/core/ecs/Component\";\nimport {\n  CODE_LOADER_MODULE_NAME,\n  getGlobalStorage,\n} from \"@aptero/axolotis-player\";\n\nexport class Factory implements WebpackLazyModule, Service<WorldService> {\n  constructor() {}\n\n  async createService(services: LazyServices): Promise<WorldService> {\n    return new WorldService(services);\n  }\n}\n\nlet addOnWorldChangeCallback: (() => void)[] = []; //do not use events emitter here to avoid surcharing dependencies in the code modules\nlet addOnWorldAddedCallback: (() => void)[] = []; //do not use events emitter here to avoid surcharing dependencies in the code modules\ninterface Worlds {\n  world: WorldEntity;\n  activeWorld: number;\n  worlds: WorldEntity[];\n}\n\nif (!getGlobalStorage<Worlds>(\"worlds\").activeWorld) {\n  //initialize world service\n  getGlobalStorage<Worlds>(\"worlds\").worlds = new Set();\n  getGlobalStorage<Worlds>(\"worlds\").activeWorld = -1;\n}\n\nexport function registerNewWorld(worldEntity: WorldEntity) {\n  const worlds = getGlobalStorage<Worlds>(\"worlds\");\n  worlds.worlds.add(worldEntity);\n  if (worlds.activeWorld < 0) {\n    worlds.activeWorld = 0;\n    worlds.world = worlds.worlds[worlds.activeWorld];\n  }\n}\n\nexport class WorldService implements Component {\n  private world: WorldEntity;\n\n  constructor(services: LazyServices) {\n    registerNewWorld(services.getWorld());\n    console.log(\"info\");\n    let worldtmp: any = null;\n    for (const world of this.getWorlds()) {\n      let wservices = world.getFirstComponentByType<Services>(Services.name);\n      if (wservices == services) {\n        worldtmp = world;\n      }\n    }\n    if (!worldtmp) {\n      throw new Error();\n    }\n    this.world = worldtmp;\n\n    //new world service is new world event\n    services\n      .getService<InitialComponentLoader>(CODE_LOADER_MODULE_NAME)\n      .then(async (codeLoader) => {\n        codeLoader.awaitInitialLoading();\n        for (const callback of addOnWorldAddedCallback) {\n          callback();\n        }\n      });\n\n    if (getGlobalStorage<Worlds>(\"worlds\").activeWorld >= 0) {\n      this.setActiveWorldByNumber(\n        getGlobalStorage<Worlds>(\"worlds\").activeWorld\n      );\n    }\n  }\n\n  getType(): string {\n    return WorldService.name;\n  }\n\n  getWorlds(): WorldEntity[] {\n    let globalStorage = getGlobalStorage<Worlds>(\"worlds\");\n    return globalStorage.worlds;\n  }\n\n  getActiveWorld() {\n    let globalStorage = getGlobalStorage<Worlds>(\"worlds\");\n    return this.getWorlds()[globalStorage.activeWorld];\n  }\n\n  isActiveWorld() {\n    return this.world == this.getActiveWorld();\n  }\n\n  addOnWorldChangeCallback(callback: () => void, init: boolean = false) {\n    addOnWorldChangeCallback.push(callback);\n    if (init) {\n      callback();\n    }\n  }\n\n  addOnWorldAdded(callback: () => void, init: boolean = false) {\n    addOnWorldAddedCallback.push(callback);\n    if (init) {\n      callback();\n    }\n  }\n\n  setActiveWorld(world: WorldEntity) {\n    for (let i = 0; i < this.getWorlds().length; i++) {\n      if (world == this.getWorlds()[i]) {\n        this.setActiveWorldByNumber(i);\n        return;\n      }\n    }\n    throw new Error();\n  }\n\n  setActiveWorldByNumber(number: number) {\n    if (getGlobalStorage<Worlds>(\"worlds\").activeWorld != number) {\n      getGlobalStorage<Worlds>(\"worlds\").activeWorld = number;\n      getGlobalStorage<Worlds>(\"worlds\").world = this.getWorlds()[number];\n      for (const callback of addOnWorldChangeCallback) {\n        callback();\n      }\n    }\n  }\n}\n"],"names":["Factory","constructor","services","WorldService","addOnWorldChangeCallback","addOnWorldAddedCallback","registerNewWorld","worldEntity","worlds","getGlobalStorage","add","activeWorld","world","Set","getWorld","console","log","worldtmp","this","getWorlds","getFirstComponentByType","Services","Error","getService","CODE_LOADER_MODULE_NAME","then","async","codeLoader","awaitInitialLoading","callback","setActiveWorldByNumber","getType","name","getActiveWorld","globalStorage","isActiveWorld","init","push","addOnWorldAdded","setActiveWorld","i","length","number"],"sourceRoot":""}